<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealReport</title>

    <!-- í°íŠ¸ ë¯¸ë¦¬ ë¡œë“œ ì„¤ì • -->
    <link rel="preload" href="./js/pdffonts/NanumGothic.otf" as="font" type="font/otf" crossorigin="anonymous" />
    <link rel="preload" href="./js/pdffonts/NanumGothicBold.otf" as="font" type="font/otf" crossorigin="anonymous" />

    <!-- ë¦¬ì–¼ë¦¬í¬íŠ¸, ë¦¬ì–¼ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ css ì„¤ì • -->
    <link href="./js/realreport/realreport.css" rel="stylesheet" />
    <link href="./js/realmap/realmap-style.css" rel="stylesheet" />

    <!-- ë¦¬ì–¼ë§µ ë¼ì´ì„¼ìŠ¤ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • -->
    <script type="text/javascript" src="./js/realmap/realmap.lic.js"></script>
    <script type="text/javascript" src="./js/realmap/realmap.1.0.13.min.js"></script>

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ pdfkit.js ì„¤ì • -->
    <script type="text/javascript" src="./js/pdfkit.js"></script>
    <script type="text/javascript" src="./js/realreport/realreport.js"></script>
    <style>
        body {
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .viewer-container {
            position: relative;
            display: flex;
            gap: 1.275rem;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .viewer-item {
            display: flex;
            flex-direction: column;
            flex: 1 1 50%;
            overflow: hidden;
        }

        .viewer-title {
            display: block;
            font-weight: bold;
        }

        .viewer-title-bar {
            flex: 1;
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border: 1px solid #d5d5d5;
            background-color: #f5f5f5;
        }

        .scroller {
            position: relative;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: 1px dashed #3a3a3a;
            padding-top: 20px;
            overflow: auto;
        }

        #markany-viewer {
            width: 100%;
            height: 100%;
        }

        #pdf-render-viewer {
            position: relative;
            display: flex;
            justify-content: center;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: 1px dashed #3a3a3a;
            padding-top: 20px;
            overflow: auto;
        }

        #pdf-markany-canvas {
            left: var(--pdf-left, 0);
            width: auto;
            height: calc(100% - 20px);
            box-sizing: border-box;
            border: 1px solid gray;
            box-shadow: rgba(50, 54, 57, 0.15) 0px 1px 3px 1px;
        }

        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- pdf.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ìš© -->
    <script type="module">
        import * as pdfjsLib from './js/pdfjs/pdf.mjs';
        window.pdfjsLib = pdfjsLib;

        pdfjsLib.GlobalWorkerOptions.workerSrc = "./js/pdfjs/pdf.worker.mjs";
    </script>
</head>

<body>
    <div class="container">
        <div style="border-bottom: 1px solid #d5d5d5; margin-bottom: 10px;">
            <h3 style="margin-top: 4px; margin-bottom: 4px;">ë¦¬ì–¼ë¦¬í¬íŠ¸ HTML5 ë¦¬í¬íŠ¸ ë·°ì–´ - MarkAny ìœ„ë³€ì¡°ë°©ì§€ ì ìš© ì˜ˆì œ</h2>
                <p>
                    ì¢Œì¸¡ì€ ë¦¬ì–¼ë¦¬í¬íŠ¸ HTML5 ë¦¬í¬íŠ¸ ë·°ì–´ë¡œ ë¯¸ë¦¬ë³´ê¸°í•œ ë³´ê³ ì„œì´ë©°, ìš°ì¸¡ì€
                    ì¢Œì¸¡ ë³´ê³ ì„œë¥¼ pdfë¡œ ë³€í™˜ í›„, MarkAny ìœ„ë³€ì¡°ë°©ì§€ ì†”ë£¨ì…˜ì„ ì—°ë™í•˜ì—¬ ì ìš©í•œ ë³´ê³ ì„œì…ë‹ˆë‹¤.
                </p>
        </div>
        <div class="viewer-container">
            <div class="viewer-item">
                <div class="viewer-title-bar">
                    <span class="viewer-title">ë¦¬ì–¼ë¦¬í¬íŠ¸ ë·°ì–´ ë¯¸ë¦¬ë³´ê¸°</span>
                    <button onclick="viewerPrint()">ğŸ–¨ï¸ ì¶œë ¥</button>
                    <button onclick="viewerExportPdf()">ğŸ“„ PDF</button>
                </div>
                <div class="scroller">
                    <div id="markany-viewer"></div>
                </div>
            </div>
            <div class="viewer-item">
                <div class="viewer-title-bar">
                    <span class="viewer-title">MarkAny ìœ„ë³€ì¡°ë°©ì§€ ì ìš© ë³´ê³ ì„œ</span>
                    <button onclick="printPdf()">ğŸ–¨ï¸ ì¶œë ¥</button>
                    <button onclick="downloadPdf()">ğŸ“„ PDF</button>
                </div>
                <div id="pdf-render-viewer"></div>
            </div>
            <div id="loadingOverlay" style="display: flex;">
                <div class="spinner"></div>
                <p id="loadingText">ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>
</body>
<script>
    // ì•„ë˜ ë¼ì´ì„ ìŠ¤ëŠ” ìœ íš¨ê¸°ê°„ 2025ë…„ 12ì›” 31ì¼ ê¹Œì§€ demo.realreport.co.kr, demo.real-report.com, 127.0.0.1, localhost ë„ë©”ì¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¼ì´ì„ ìŠ¤ ì…ë‹ˆë‹¤.
    var realReportLic =
        'upVcPE+wPOn1V3OcjC3PuAUt7xtLcP5XVzS0GnpZwpnbdxrzWi3SH8gD17wvi7BNc3vsxq2SxIg2rsOxQPdOVcH1h2aog657J5pkitVHVM3QPF6bsDlKl8NgIi+ScmQJ1bTAmKPP6lA5wBxY4TtZU7AcvKUogurDIt4EOB5WH41Xh9a38ypSmQ==';
    const reportViewerContainerId = 'markany-viewer';
    const markanyPdfViewerContainerId = 'pdf-render-viewer';
    const markanyPdfCanvasId = 'pdf-markany-canvas';
    var pdfBlob = null;

    var viewer;

    var init = function (reports) {
        // ë‹¨ì¼ ì–‘ì‹ ë¦¬í¬íŠ¸ëŠ” ReportViewer ê°ì²´ë¥¼ ì´ìš©í•œë‹¤.
        // ìƒì„±ì¸ìëŠ” ì»¨í…Œì´ë„ˆId, ë¦¬í¬íŠ¸ ì–‘ì‹, ë°ì´í„°
        // ë„ì›€ë§ ì°¸ì¡° ğŸ’¡ https://real-report.com/docs/api/ReportViewer
        viewer = new RealReport.ReportViewer(
            reportViewerContainerId,
            reports?.form,
            reports?.dataSet,
        );
    };

    function viewerPrint() {
        if (viewer) {
            viewer.print();
        }
    }

    async function viewerExportPdf() {
        const [regularFont, boldFont] = await Promise.all([
            base64convert('/js/pdffonts/NanumGothic.otf', true),
            base64convert('/js/pdffonts/NanumGothicBold.otf', true),
        ])

        const fonts = [
            {
                name: 'regular',
                content: regularFont,
                style: 'normal',
                weight: 'normal',
            },
            {
                name: 'bold',
                content: boldFont,
                style: 'normal',
                weight: 'bold',
            },
        ];

        if (viewer) {
            const options = {
                fonts,
                filename: 'sample-report',
                preview: false,
                // ownerPassword: '!QAZXSW2', // ì†Œìœ ì ì•”í˜¸
                // userPassword: '1qazxsw2', // ì‚¬ìš©ì ì•”í˜¸
                permissions: {
                    printing: 'highResolution', // 'lowResolution' | 'highResolution' ì¸ì‡„ í—ˆìš© ì—¬ë¶€
                    modifying: true, // íŒŒì¼ ìˆ˜ì • í—ˆìš© ì—¬ë¶€
                    copying: true, // í…ìŠ¤íŠ¸ ë˜ëŠ” ê·¸ë˜í”½ ë³µì‚¬ í—ˆìš© ì—¬ë¶€
                    annotating: true, // ì£¼ì„ ë° ì–‘ì‹ ì‘ì„± í—ˆìš© ì—¬ë¶€
                    fillingForms: true, // ì–‘ì‹ ì‘ì„± ë° ì„œëª… í—ˆìš© ì—¬ë¶€
                    contentAccessibility: true, // ì ‘ê·¼ì„±ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ë³µì‚¬ í—ˆìš© ì—¬ë¶€
                    documentAssembly: true,
                },
                pdfVersion: '1.7ext3', // '1.3' | '1.4' | '1.5' | '1.6' | '1.7' | '1.7ext3'
            };
            const oldZoom = viewer.zoom;
            viewer.zoom = 1;
            await viewer.exportPdf(options);
            viewer.zoom = oldZoom;
        }
    }

    async function viewerExportPdfBlob() {
        const [regularFont, boldFont] = await Promise.all([
            base64convert('/js/pdffonts/NanumGothic.otf', true),
            base64convert('/js/pdffonts/NanumGothicBold.otf', true),
        ])

        const fonts = [
            {
                name: 'regular',
                content: regularFont,
                style: 'normal',
                weight: 'normal',
            },
            {
                name: 'bold',
                content: boldFont,
                style: 'normal',
                weight: 'bold',
            },
        ];

        if (viewer) {
            const options = {
                fonts,
                filename: 'sample-report',
                preview: false,
                // ownerPassword: '!QAZXSW2', // ì†Œìœ ì ì•”í˜¸
                // userPassword: '1qazxsw2', // ì‚¬ìš©ì ì•”í˜¸
                permissions: {
                    printing: 'highResolution', // 'lowResolution' | 'highResolution' ì¸ì‡„ í—ˆìš© ì—¬ë¶€
                    modifying: true, // íŒŒì¼ ìˆ˜ì • í—ˆìš© ì—¬ë¶€
                    copying: true, // í…ìŠ¤íŠ¸ ë˜ëŠ” ê·¸ë˜í”½ ë³µì‚¬ í—ˆìš© ì—¬ë¶€
                    annotating: true, // ì£¼ì„ ë° ì–‘ì‹ ì‘ì„± í—ˆìš© ì—¬ë¶€
                    fillingForms: true, // ì–‘ì‹ ì‘ì„± ë° ì„œëª… í—ˆìš© ì—¬ë¶€
                    contentAccessibility: true, // ì ‘ê·¼ì„±ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ë³µì‚¬ í—ˆìš© ì—¬ë¶€
                    documentAssembly: true,
                },
                pdfVersion: '1.7ext3', // '1.3' | '1.4' | '1.5' | '1.6' | '1.7' | '1.7ext3'
            };
            const oldZoom = viewer.zoom;
            viewer.zoom = 1;
            const pdfBlob = await viewer.exportPdfBlob(options);
            viewer.zoom = oldZoom;

            return pdfBlob;
        }
    }

    /**
     * ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰
     * */
    var previewReport = async function (reports) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        loadingOverlay.style.display = 'flex';
        loadingText.textContent = 'ë¦¬ì–¼ë¦¬í¬íŠ¸ PDF ë³€í™˜ ì¤‘...';

        viewer.reportForm = reports?.form;
        viewer.dataSet = reports?.dataSet;

        // async: trueì¸ ê²½ìš° ë§¤ í˜ì´ì§€ê°€ ë¯¸ë¦¬ë³´ê¸°ë ë•Œ ë§ˆë‹¤ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
        const pageCallback = (ctx, page, pageNo) => {
            console.log(`${pageNo} í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸° ì™„ë£Œ`);
        };

        // async: trueì¸ ê²½ìš° ëª¨ë“  í˜ì´ì§€ì˜ ë¯¸ë¦¬ë³´ê¸°ê°€ ì™„ë£Œë ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
        const endCallback = async (ctx, pages) => {
            viewer.fitToHeight();

            await new Promise((resolve) => setTimeout(resolve, 300));

            loadingText.textContent = 'PDF ë¬¸ì„œì— MarkAny ìœ„ë³€ì¡°ë°©ì§€ ì ìš© ì¤‘...';

            // Report Viewerì—ì„œ PDF Blob ì¶”ì¶œ
            const pdfBlob = await viewerExportPdfBlob();

            // MarkAny ìœ„ë³€ì¡°ë°©ì§€ ì†”ë£¨ì…˜ ì„œë²„ë¡œ PDF Blob ì „ì†¡ ë° ì²˜ë¦¬ í›„ ê²°ê³¼ PDF ë²„í¼ ìˆ˜ì‹ 
            const markanyPdfBuffer = await fetchMarkanyPdf(pdfBlob);

            // ìˆ˜ì‹ í•œ MarkAny ì²˜ë¦¬ PDF ë²„í¼ë¥¼ pdf.jsë¥¼ ì´ìš©í•˜ì—¬ ë Œë”ë§
            await renderPdf({ data: markanyPdfBuffer });

            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 300);
        };

        // ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ preview() í˜¸ì¶œ
        // í˜¸ì¶œ ì¸ìëŠ” PreviewOptionsë¡œ ìì„¸í•œ ì†ì„±ì€ ë„ì›€ë§ ì°¸ì¡°
        // ğŸ’¡ https://real-report.com/docs/api/ReportViewer#preview
        if (viewer) {
            viewer.preview({
                async: true,
                pageMark: false,
                noScroll: true,
                callback: pageCallback,
                endCallback: endCallback,
            });
        }

        return viewer;
    };

    async function base64convert(url, split) {
        const data = await fetch(url);
        const blob = await data.blob();

        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result;
                resolve(split ? base64data.split(',')[1] : base64data);
            };
        });
    }

    async function fetchMarkanyPdf(pdfFileBlob) {
        const formData = new FormData();
        formData.append('file', pdfFileBlob);
        /**
         * d2CellCount: ë°”ì½”ë“œ ê°€ë¡œ ì…€ ê¸¸ì´ 19.66 -> 1cm ëŠ˜ì–´ë‚¨ (ê° ë°”ì½”ë“œ 3ê°œ ê¸°ì¤€ìœ¼ë¡œ 19.66 -> 0.33cm)
         * d2CellRow: ë°”ì½”ë“œ ì„¸ë¡œ ê¸¸ì´ 59 -> 1cm
         * ë°”ì½”ë“œ ì˜ì—­ì™¸ì— ì„¸ë¡œë¡œ 0.1cm ì—¬ìœ  ê³µê°„ í•„ìš” 5.9 -> 0.1cm
         * d2PosX: ë°”ì½”ë“œ x ì‹œì‘ ì¢Œí‘œ 28.35 -> 1cm
         * d2PosY: ë°”ì½”ë“œ y ì‹œì‘ ì¢Œí‘œ 28.35 -> 1cm
         * ë°”ì½”ë“œ í…Œë‘ë¦¬ ë° ê°„ê²©ìœ¼ë¡œ ì—¬ìœ ê³µê°„ ê°€ë¡œ 0.6cm, ì„¸ë¡œ 0.1cm í•„ìš”
         * A4 ê¸°ì¤€ (210mm x 297mm)
         * ì—¬ë°± ê°€ë¡œ 4cm, í•˜ë‹¨ 1cm ì–‘ì‹ ê¸°ì¤€
         * ì‹¤ì œ ë°”ì½”ë“œê°€ ì°¨ì§€í•  ìˆ˜ ìˆëŠ” ê³µê°„:
         * 17cm - 0.6cm = 16.4cm
         * ë°”ì½”ë“œ 1ê°œë‹¹ í• ë‹¹ ê³µê°„: 16.4cm Ã· 3ê°œ = 5.466666...cm
         * d2CellCount ì •í™•í•œ ê°’: 19.66 Ã— 5.466666... Ã— 3 = 322.42
         */
        formData.append(
            'param',
            '{"d2CellCount": 321, "d2CellRow": 118, "d2PosX": 58, "d2PosY": 28, "piCDUse": 0}',
        );

        try {
            const response = await fetch('http://52.78.152.94:10101/upload', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer 101da1matians01`, // ì˜ˆì‹œ í† í°, ì‹¤ì œë¡œëŠ” í™˜ê²½ë³€ìˆ˜ë‚˜ ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ê´€ë¦¬í•´ì•¼ í•¨
                },
                body: formData,
            });

            if (!response.ok) {
                throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + response.statusText);
            }

            const result = await response.arrayBuffer();

            // blob ìƒì„±
            pdfBlob = new Blob([result], { type: 'application/pdf' });

            // ê²°ê³¼ return
            return result;
        } catch (err) {
            console.error('ì—ëŸ¬:', err);
        }
    }

    async function renderPdf({ data }) {
        const pdfContainer = document.getElementById(markanyPdfViewerContainerId);
        if (!pdfContainer) {
            throw new Error('PDF container not found');
        }

        const pdf = await pdfjsLib.getDocument({ data }).promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);

            const viewport = page.getViewport({ scale: 2 });
            const canvas = document.createElement('canvas');
            canvas.id = markanyPdfCanvasId;

            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            pdfContainer.appendChild(canvas);

            const renderContext = {
                canvasContext: context,
                canvas: canvas,
                viewport: viewport,
            };

            await page.render(renderContext).promise;
        }
    }

    function downloadPdf({ filename = "markany-protected-report.pdf" } = {}) {
        const blobUrl = URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = blobUrl;
        link.download = filename;
        
        // í´ë¦­ íŠ¸ë¦¬ê±°
        document.body.appendChild(link);
        link.click();
        
        // ì •ë¦¬
        document.body.removeChild(link);
        URL.revokeObjectURL(blobUrl);
    }

    function printPdf() {
        const blobUrl = URL.createObjectURL(pdfBlob);
        const pdfFrame = document.getElementById('rr-pdf-print-iframe');
        const isPdfFrameExist = pdfFrame;

        if (isPdfFrameExist) {
            URL.revokeObjectURL(pdfFrame.src);
            pdfFrame.remove();
        }

        const iframe = document.createElement('iframe');
        iframe.id = 'rr-pdf-print-iframe';
        iframe.style.display = 'none';
        iframe.src = blobUrl;

        iframe.onload = () => {
            const contentWindow = iframe.contentWindow;

            contentWindow.focus();
            contentWindow.print();
        }

        document.body.appendChild(iframe);
    }
</script>

</html>