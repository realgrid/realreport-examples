<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealReport Preview</title>
    <link rel="shortcut icon" href="#">

    <link href="index.css" rel="stylesheet">
    <link href='js/realreport/realreport.css' rel='stylesheet' />
    <script type="text/javascript" src="js/highcharts/highcharts.js"></script>
    <script type="text/javascript" src="js/highcharts/highcharts-more.js"></script>
    <script type="text/javascript" src="js/pdfkit.js"></script>
    <script type="text/javascript" src='js/realreport/realreport.js'></script>
    <script type="text/javascript" src="reports/report-form.js"></script>
    <script type="text/javascript" src="reports/master-data.js"></script>
    <script type="text/javascript" src="reports/detail-data.js"></script>
</head>

<body>
    <div class="main">
        <div class="main-header">
            <img src="./images/logo.png">
        </div>
        <div class="main-contents">
            <div class="main-sidebar">
                <div>급여명세서</div>
            </div>
            <div class="main-content">
                <div class="preview-toolbar">
                    <div class="toolbar-scrolller">
                        <div class="toolbar-left">
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-zoomout-png" onclick="onClickZoomOut10()"></div>
                                <input part="input" type="text" value="100%" id="inputZoomScale" aria-label="Zoom Scale"
                                    class="mobile-hidden">
                                <div class="toolbar-icon icon preview-zoomin-png" onclick="onClickZoomIn10()"></div>
                                <div class="toolbar-icon icon preview-100-png" onclick="onClickZoom100()"></div>
                                <div class="toolbar-icon icon preview-fit-to-width-png" onclick="onClickFitToWidth()">
                                </div>
                                <div class="toolbar-icon icon preview-fit-to-height-png" onclick="onClickFitToHeight()">
                                </div>
                                <div class="toolbar-icon icon preview-fit-to-page-png" onclick="onClickFitToPage()">
                                </div>
                            </div>
                        </div>
                        <div class="toolbar-center">
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-first-png" onclick="onClickFirstPage()"></div>
                                <div class="toolbar-icon icon preview-prev-png" onclick="onClickPrevPage()"></div>
                                <div class="toolbar-item">
                                    <input part="input" type="text" value="1" id="inputPageNumber"
                                        aria-label="Page number">
                                    <span style="margin: 0 4px">/</span>
                                    <span style="margin: 0 4px" id="totalpage">1</span>
                                </div>
                                <div class="toolbar-icon icon preview-next-png" onclick="onClickNextPage()"></div>
                                <div class="toolbar-icon icon preview-last-png" onclick="onClickLastPage()"></div>
                            </div>
                        </div>
                        <div class="toolbar-right">
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-print-png" onclick="onClickPrintPopup()"></div>
                            </div>
                            <span class="vertical-separator"></span>
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-print-png" onclick="onClickPrintHiddenFrame()">
                                </div>
                            </div>
                            <span class="vertical-separator"></span>
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-pdf-png" onclick="onClickExportPdf()"></div>
                                <div class="toolbar-icon icon preview-hwp-png" onclick="onClickExportDoc('hwp')"></div>
                                <div class="toolbar-icon icon preview-docx-png" onclick="onClickExportDoc('docx')">
                                </div>
                                <div class="toolbar-icon icon preview-pptx-png" onclick="onClickExportDoc('pptx')">
                                </div>
                            </div>
                            <span class="vertical-separator"></span>
                            <div class="toolbar-items">
                                <div class="toolbar-icon icon preview-png-png" onclick="onClickExportImage('png')">
                                </div>
                                <div class="toolbar-icon icon preview-jpeg-png" onclick="onClickExportImage('jpeg')">
                                </div>
                                <div class="toolbar-icon icon preview-gif-png" onclick="onClickExportImage('gif')">
                                </div>
                                <div class="toolbar-icon icon preview-tiffg3-png"
                                    onclick="onClickExportImage('tiff', 'g3')"></div>
                                <div class="toolbar-icon icon preview-tiffg4-png"
                                    onclick="onClickExportImage('tiff', 'g4')"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="scroller">
                    <div id="realreport"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 아래 라이선스는 유효기간 2024년 1월 31일 까지 localhost, 127.0.0.1 또는 real-report.com 도메인에서 사용할 수 있는 라이선스 입니다.
        var realReportLic = 'upVcPE+wPOkcfqywe+clVN+UVTCvO3is+83EYTz6U/sTXJR8Yw8Y0WXyjOMqbrgvr3+iyFPC2UvWntFnlQAvG/WiN+dO0JtjdX/TRvH17asONaYpJP0FO3omxwgpdzq2I8zB1XKm5AAz/VxgxdBn+fumRlcQ8Ue0';
        // RealReport Viewer 객체 변수
        var viewer;

        // 리포트 preview
        document.addEventListener('DOMContentLoaded', function () {
            viewer = new RealReport.ReportViewer('realreport', reportForm, {
                master: {
                    values: masterData,
                },
                detail: {
                    values: detailData,
                },
            });

            viewer.preview();
        });
        //--------------------------------------------------------------------------------------------------
        // public methods
        //--------------------------------------------------------------------------------------------------

        const setTotalPage = function (id) {
            if (viewer) {
                setHtml(id, viewer.pageCount, '', '');
            }
        }

        /**
         * 인쇄를 위해 별도 페이지로 미리보기 하는 방법
         * 도움말 참조 💡 https://real-report.com/docs/guide/viewer/print
         * */
        var printPopup = function () {
            if (viewer) {
                const w = Math.min(screen.width, 1024);
                const h = Math.min(screen.height, 768);
                const x = (screen.width - w) / 2;
                const y = (screen.height - h) / 2;
                const win = window.open('./print.html', 'print', "left=" + x + ",top=" + y + ",width=" + w + ",height=" + h);

                // 페이지가 로드된 다음 즉시 프린트 실행
                win.addEventListener('DOMContentLoaded', function (e) {
                    const dom = win.document.getElementById('realreport');
                    dom.innerHTML = viewer.reportHtml;
                    // 실제 프린트 함수 호출 (아래 주석 제거)
                    win.print();
                });

                // 프린트한 다음 팝업창 닫기
                win.addEventListener('afterprint', function (e) {
                    win.close();
                });
            }
        }

        //--------------------------------------------------------------------------------------------------
        // 이벤트 핸들링
        //--------------------------------------------------------------------------------------------------

        /**
         * z 비율 만큼 확대 또는 축소
         * 💡 https://real-report.com/docs/guide/viewer/zoom
         * */
        const onClickZoom = (z) => {
            if (viewer) {
                viewer.zoom = z;
            }
        }

        /**
         * 미리보기 화면 10% 확대
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#zoom
         * */
        const onClickZoomIn10 = function () {
            if (viewer) {
                viewer.zoomIn();
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 미리보기 화면 10% 축소
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#zoomout
         * */
        const onClickZoomOut10 = function () {
            if (viewer) {
                viewer.zoomOut();
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 미리보기 화면 1:1 비율
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#zoomout
         * */
        const onClickZoom100 = function () {
            if (viewer) {
                viewer.zoom = 1;
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 미리보기 페이지 크기를 컨테이너 높이에 맞게 조정
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#fittoheight
         * */
        const onClickFitToHeight = function () {
            if (viewer) {
                viewer.fitToHeight();
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 미리보기 페이지 크기를 컨테이너 너비에 맞게 조정
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#fittowidth
         * */
        const onClickFitToWidth = function () {
            if (viewer) {
                viewer.fitToWidth();
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 미리보기 페이지 크기를 컨테이너 너비와 높이에 맞게 조정
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#fittopage
         * */
        const onClickFitToPage = function () {
            if (viewer) {
                viewer.fitToPage();
                setZoomScaleInputValue('inputZoomScale');
            }
        }

        /**
         * 첫 번째 페이지로 이동
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#first
         * */
        const onClickFirstPage = function () {
            if (viewer) {
                viewer.first();
                setPageInputValue('inputPageNumber');
            }
        }

        /**
         * 마지막 페이지로 이동
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#last
         * */
        const onClickLastPage = function () {
            if (viewer) {
                viewer.last();
                setPageInputValue('inputPageNumber');
            }
        }

        /**
         * 이전 페이지로 이동
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#prev
         * */
        const onClickPrevPage = function () {
            if (viewer) {
                viewer.prev();
                setPageInputValue('inputPageNumber');
            }
        }

        /**
         * 다음 페이지로 이동
         * 💡 https://real-report.com/docs/api/viewer/reportviewer#first
         * */
        const onClickNextPage = function () {
            if (viewer) {
                viewer.next();
                setPageInputValue('inputPageNumber');
            }
        }

        /**
         * PDF 내보내기
         * 💡 https://real-report.com/docs/guide/viewer/export#pdf-%EB%82%B4%EB%B3%B4%EB%82%B4%EA%B8%B0
         * */
        const onClickExportPdf = function () {
            const zoomSclae = viewer.zoom
            base64convert('./js/pdffonts/malgun.ttf', true).then(regularFont => {
                base64convert('./js/pdffonts/malgunbd.ttf', true).then(async boldFont => {
                    const fonts = [{
                        name: 'regular',
                        content: regularFont,
                        style: 'normal',
                        weight: 'normal',
                    },
                    {
                        name: 'bold',
                        content: boldFont,
                        style: 'normal',
                        weight: 'bold',
                    }];

                    if (viewer) {
                        const options = {
                            fonts,
                            filename: 'sample-report',
                            preview: false,
                            // ownerPassword: '!QAZXSW2', // 소유자 암호
                            // userPassword: '1qazxsw2', // 사용자 암호
                            permissions: {
                                printing: 'highResolution', // 'lowResolution' | 'highResolution' 인쇄 허용 여부
                                modifying: true, // 파일 수정 허용 여부
                                copying: true, // 텍스트 또는 그래픽 복사 허용 여부
                                annotating: true, // 주석 및 양식 작성 허용 여부
                                fillingForms: true, // 양식 작성 및 서명 허용 여부
                                contentAccessibility: true, // 접근성을 위한 텍스트 복사 허용 여부
                                documentAssembly: true,
                            },
                            pdfVersion: '1.7ext3'  // '1.3' | '1.4' | '1.5' | '1.6' | '1.7' | '1.7ext3'
                        }
                        viewer.zoom = 1
                        viewer.exportPdf(options)
                        viewer.zoom = zoomSclae
                    }
                });
            });
        }

        /**
         * HWP, DOCX, PPTX 문서 내보내기
         * 💡 https://real-report.com/docs/guide/viewer/export#%EB%AC%B8%EC%84%9C-%EB%82%B4%EB%B3%B4%EB%82%B4%EA%B8%B0
         * */
        const onClickExportDoc = function (type) {
            if (viewer) {
                viewer.exportDocument({ type });
            }
        }

        /**
         * PNG, JPEG, GIF, TIF, TIFF 이미지 내보내기 함수
         * 💡 https://real-report.com/docs/guide/viewer/export#%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%82%B4%EB%B3%B4%EB%82%B4%EA%B8%B0
         * */
        const onClickExportImage = function (type, encoding, fileName) {
            if (viewer) {
                var originZoom = viewer.zoom;
                viewer.zoom = 1;
                var options = { type };
                if (encoding) options.tiff = { encoding };
                if (fileName) options.fileName = fileName;
                viewer.exportImage(options);
                viewer.zoom = originZoom;
            }
        }

        /**
         * 숨겨진 iFrame을 이용해 미리보기 상태에서 바로 출력
         * 💡 https://real-report.com/docs/guide/viewer/print#%EC%88%A8%EA%B2%A8%EC%A7%84-iframe-%EC%9D%B4%EC%9A%A9
         * */
        const onClickPrintHiddenFrame = function () {
            if (viewer) {
                function closePrint() {
                    document.body.removeChild(this.__container__);
                }

                function setPrint() {
                    this.contentWindow.__container__ = this;
                    this.contentWindow.onbeforeunload = closePrint;
                    this.contentWindow.onafterprint = closePrint;
                    const dom = this.contentWindow.document.getElementById('realreport');
                    dom.innerHTML = viewer.reportHtml;

                    setTimeout(() => {
                        this.contentWindow.focus(); // Required for IE
                        this.contentWindow.print();
                    }, 1);
                }

                function printPage(sURL) {
                    var oHideFrame = document.createElement("iframe");
                    oHideFrame.onload = setPrint;
                    oHideFrame.style.position = "";
                    oHideFrame.style.right = "0";
                    oHideFrame.style.bottom = "0";
                    oHideFrame.style.width = "0";
                    oHideFrame.style.height = "0";
                    oHideFrame.style.border = "0";
                    oHideFrame.src = sURL;
                    document.body.appendChild(oHideFrame);
                }

                printPage('./print.html');
            }
        }

        const onClickPrintPopup = function () {
            printPopup();
        }


        //--------------------------------------------------------------------------------------------------
        // private methods
        //--------------------------------------------------------------------------------------------------

        const zoom = document.getElementById('inputZoomScale');
        zoom.addEventListener('change', (e) => {
            let zoom = e.target.value;
            if (zoom.endsWith('%')) zoom = zoom.replace('%', '');
            if (!isNaN(zoom)) {
                viewer.zoom = zoom / 100;
                setZoomScaleInputValue('inputZoomScale');
            }
        })

        const page = document.getElementById('inputPageNumber');
        page.addEventListener('change', (e) => {
            const page = e.target.value;
            if (!isNaN(page)) {
                viewer.page = page;
                setPageInputValue('inputPageNumber');
            }
        })

        const setInputValue = function (id, value, prefix, surfix) {
            if (id) {
                const input = document.getElementById(id);
                if (input) input.value = `${prefix || ''}${value}${surfix || ''}`;
            }
        }

        const setZoomScaleInputValue = function (id) {
            setInputValue(id, Math.trunc(viewer.zoom * 100), '', '%');
        }

        const setPageInputValue = function (id) {
            if (viewer) {
                setInputValue(id, viewer.page);
            }
        };

        async function base64convert(url, split) {
            const data = await fetch(url);
            const blob = await data.blob();

            return new Promise(resolve => {
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    const base64data = reader.result;
                    resolve(split ? base64data.split(',')[1] : base64data);
                }
            });
        }

    </script>
</body>

</html>